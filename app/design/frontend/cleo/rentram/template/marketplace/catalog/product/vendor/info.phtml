<?php
/**
 * Medma Marketplace
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Team
 * that is bundled with this package of Medma Infomatix Pvt. Ltd.
 * =================================================================
 *                 MAGENTO EDITION USAGE NOTICE
 * =================================================================
 * This package designed for Magento COMMUNITY edition
 * Contact us Support does not guarantee correct work of this package
 * on any other Magento edition except Magento COMMUNITY edition.
 * =================================================================
 *
 * @category    Medma
 * @package     Medma_MarketPlace
**/
$isCustomerLoggedIn = Mage::getSingleton('customer/session')->isLoggedIn();
$vendorRating = $this->getVendorRating();
$vendorInfo = $this->getVendorInfo();
$_product = $this->getProduct();
$isConstructor = false;
$categoryIds = $_product->getCategoryIds();
foreach($categoryIds as $catID  ){

    if($catID == 2){
      $secondCategoryId = $categoryIds[2];
      $categoryData = Mage::getModel('catalog/category')->load($secondCategoryId);
    }
    $_category = Mage::getModel('catalog/category')->load($catID);
    Mage::log(	$_category->getName() ,Zend_log::INFO,'layout.log',true);
    if($_category->getName()=="Construction Equipments"){
      $isConstructor = true;
    }

}


//    Mage::log($_product->getId(),Zend_log::INFO,'layout.log',true);

?>

<?php   if($vendorInfo): ?>
<div class="box-collateral box-description">
	<div class="std">
    <table class="data-table" id="product-attribute-specs-table">
		        <colgroup><col style="width: 25%">
		        <col>
		        </colgroup>
						<tbody>
		            <tr>
		                <th class="label">Shop Name</th>
		                <td class="data">
										<!--		<php if($_category->getName()=="Construction Equipments"): ?>
												<a style="font-size: 17px; text-decoration: underline; color: cornflowerblue;" href="<php echo $this->getVendorProfileUrl($vendorInfo->getId()); ?>" >
													<php  echo $vendorInfo->getShopName(); ?>
												</a>
												<php endif; ?>  -->
												<?php echo $vendorInfo->getShopName(); ?>
										</td>

		            </tr>
								<?php if($isConstructor): ?>
		            <tr >
		                <th class="label">Contact</th>
		                <td class="data">	<button  class="btn btn-default" onclick="informationPopup()">View contact</button>	</td>
		            </tr>

								<?php endif; ?>
								<tr>
										<th class="label">City</th>
										<td class="data">		<?php 	echo $vendorInfo->getCity(); ?></td>
								</tr>
		            <tr>
		                <th class="label">Description</th>
		                <td class="data">	<?php 	echo $vendorInfo->getMessage(); ?></td>
		            </tr>
                <?php if(count($vendorRating)): ?>
                    <?php foreach($vendorRating as $rating): ?>
		            <tr>
                    <th class="label"><?php echo $rating['name']; ?></th>
                  <td class="data">
                        <div class="rating-container">
                          <div class="rating-graphics-container">
                            <div class="rating-blank"></div>
                            <div class="rating-filled" style="width: <?php echo $rating['value'] ?>%"></div>
                          </div>
                        <!--	<div class="rating-totals"><php echo str_pad($rating['records'], 3, "0", STR_PAD_LEFT); ?></div>  -->
                        </div>
                  </td>
		            </tr>
                  <?php endforeach; ?>
                <?php endif; ?>
		        </tbody>
		    </table>
	</div>

	<div class="add-to-box" style="text-align: center;  margin-top: 1%;">
		<button type="button" title="<?php echo $this->__('Add to Favourite'); ?>" class="button"
			onclick="setLocation('<?php echo $this->getAddFavouriteUrl($vendorInfo->getId()); ?>');">
			<span><span><?php echo $this->__('Add to Favourite'); ?></span></span>
		</button>
	</div>
</div>

<?php endif; ?>
<div class="modal fade" id="detailModel" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" ng-click="deleteRow()">
						<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
					</button>
					<h1 class="modal-title" id="myModalLabel" style="text-align:center;">Seller Enquiry</h1>
          <p class="modal-title"  style="text-align:center;">Please provide following details to help us serve you better.</p>
				</div>
				<div class="modal-body">
            <input type="hidden" name="customer_id" id="customer_id" value="<?php echo $customerId; ?>" />
            <input type="hidden" name="product_id" id="product_id" value="<?php echo $productId; ?>" />
            <table class="data-table" id="product-attribute-specs-table">
                <colgroup><col style="width: 25%">
                <col>
                </colgroup>
                <tbody>
                  <tr>
                    <th class="label" style="    color: black;"><b><sup>*</sup>Name : <b></th>
                    <td class="data">
                      <input type="text" id="name" onblur="hideNameValidation()" name="name" placeholder="Please enter your name" title="<?php echo $this->__('First Name'); ?>" maxlength="255" class="input-text required-entry" />
                      <div id="nameValidate" style="color:red;"></div>
      					    </td>
                  </tr>
                  <tr>
                    <th class="label" style="    color: black;"><b><sup>*</sup>Email :</b></th>
                    <td class="data">
                      <input type="text" onblur="hideEmailValidation()" placeholder="Please enter your email eg:- demo@example.com" name="email" id="email" title="<?php echo $this->__('Email Address') ?>" class="input-text validate-email required-entry" />
                      <div id="emailValidate" style="color:red;"></div>
                    </td>
                  </tr>
                  <tr>
                    <th class="label" style="color: black;"><b><sup>*</sup>Mobile :</b></th>
                    <td class="data">
                      <input type="text" onblur="hideContactValidation()" id="contact_number" placeholder="Please enter your contact eg:- 1234512345" name="contact_number" title="<?php echo $this->__('Contact Number'); ?>" maxlength="255" class="input-text required-entry validate-phoneLax" >
                      <div id="contactValidate" style="color:red;"></div>
      	             </td>
                  </tr>
                  <tr>
                    <th class="label" style="    color: black;"><b>Address </b>(optional) :</th>
                    <td class="data">	<textarea id="address" name="address" placeholder="Please enter your address" title="<?php echo $this->__('Address'); ?>" maxlength="555" class="input-text required-entry" >
                                      </textarea>
                    </td>
                  </tr>
                  <tr>
                    <td></td>
                    <td class="data" ><button type="submit"  onclick="saveData()"  class="btn btn-round btn-success" id="showBtn">Show Contact</button></td>
                  </tr>
                </tbody>
            </table>


<script type="text/javascript">
var emailReg =  /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
var saveSuccess = false;

document.getElementById('address').value='';
if('<?php echo $isCustomerLoggedIn ?>'){
  document.getElementById('name').value = "<?php echo $customerData['firstname'].' '.$customerData['lastname']  ?>";
  document.getElementById('email').value = "<?php echo $customerData['email'] ?>";
  document.getElementById('contact_number').value = "<?php echo $addressObject['telephone'] ?>";
  document.getElementById('address').value = "<?php echo $addressObject['street'].' '.$addressObject['city'].' '.$addressObject['city'] ?>";
}
  function informationPopup(){
        var array = "<?php $productViewedArray =  Mage::getSingleton('core/session' )->getData('productViewedArray'); echo implode($productViewedArray) ?>";
    if(array.indexOf("<?php echo $productId ?>") != -1 || saveSuccess){
      jQuery("#informationModel").modal("show");
    }else{
        jQuery("#detailModel").modal("show");
    }
  }
  function hideNameValidation(){
      var name = document.getElementById('name').value;
    if ( name == null ||  name == "") {
      document.getElementById('nameValidate').innerHTML = "Name is required field";
    }else{
      document.getElementById('nameValidate').innerHTML = "";
    }
  }
  function hideEmailValidation(){
    var email = document.getElementById('email').value;
    if(  email == null ||   email == "" ){
        document.getElementById('emailValidate').innerHTML = "Email is required field";
    }else if(!email.match(emailReg)){
        document.getElementById('emailValidate').innerHTML = "Email must in proper format eg:- demo@example.com";
    }else{
        document.getElementById('emailValidate').innerHTML = "";
    }
  }
  function hideContactValidation(){
    var phonenoReg = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
    var contact  =  document.getElementById('contact_number').value;
    if( contact == null ||   contact == "" ){
        document.getElementById('contactValidate').innerHTML = "Contact is required field";
    }else if(!contact.match(phonenoReg)){
        document.getElementById('contactValidate').innerHTML = "Mobile number must be in proper format eg:- 1234512345";
    }else{
        document.getElementById('contactValidate').innerHTML = "";
    }
  }
    function isValid(){
      var name = document.getElementById('name').value;
      var email = document.getElementById('email').value;
      var contact  =  document.getElementById('contact_number').value;
      var address  =  document.getElementById('address').value;
      var isValid = true ;
      var phonenoReg = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
      if ( name == null ||  name == "") {
        document.getElementById('nameValidate').innerHTML = "Name is required field";
        isValid = false;
      }
      if(  email == null ||   email == "" ){
          document.getElementById('emailValidate').innerHTML = "Email is required field";
          isValid= false;
      }else if(!email.match(emailReg)){
          document.getElementById('emailValidate').innerHTML = "Email must in proper format eg:- demo@example.com";
          isValid = false;
      }
      if( contact == null ||   contact == "" ){
          document.getElementById('contactValidate').innerHTML = "Contact is required field";
          isValid = false;
      }else if(!contact.match(phonenoReg)){
          document.getElementById('contactValidate').innerHTML = "Mobile number must be in proper format eg:- 1234512345";
          isValid = false;
      }
      return isValid;
    }
   function saveData(){
            if(!isValid()){
              return;
            }
     document.getElementById('showBtn').innerHTML="Loading...";
              new Ajax.Request("<?php echo $this->getUrl('createLog/viewer/save') ?>", {
                  method: 'Post',
                  parameters: {
                     "name" : document.getElementById('name').value,
                     "email" :document.getElementById('email').value,
                     "contact_number" : document.getElementById('contact_number').value,
                     "address" : document.getElementById('address').value,
                     "customer_id" : document.getElementById('customer_id').value,
                     "product_id" : document.getElementById('product_id').value,
                     'product_name':"<?php echo $_product['name'] ?>",
                     'product_sku':"<?php echo $_product['sku'] ?>",
                     'vendor_id':"<?php echo $vendorInfo['entity_id'] ?>",
                     'vendor_name':"<?php echo $vendorInfo['shop_name'] ?>",
                     'category_id':"<?php echo $categoryData['entity_id'] ?>",
                     'category_name':"<?php echo $categoryData['name'] ?>"
                               },
                  onComplete: function(response) {
                    console.log(response);
                    saveSuccess= true;
                     document.getElementById('name').value = '';
                     document.getElementById('email').value = '';
                     document.getElementById('contact_number').value = '';
                     document.getElementById('address').value = '';
                     jQuery("#detailModel").modal("hide");
                      jQuery("#informationModel").modal("show");
                      document.getElementById('showBtn').innerHTML="Show Contact";
                      '<?php $isSaved ="true"; ?>';
                  }
              });
          }
</script>

        </div>
			</div>
		</div>
	</div>


  <div class="modal fade" id="informationModel" tabindex="-1" role="dialog"	aria-labelledby="myModalLabel" aria-hidden="true">
  	<div class="modal-dialog">
  		<div class="modal-content">
  			<div class="modal-header">
  				<button type="button" class="close" data-dismiss="modal" ng-click="deleteRow()">
  					<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
  				</button>
  				<h1 class="modal-title" id="myModalLabel" style="text-align:center;">Seller Detail</h1>
  			</div>
  			<div class="modal-body">
          <table class="data-table" id="product-attribute-specs-table">
              <colgroup><col style="width: 25%">
              <col>
              </colgroup>
              <tbody>
                <tr>
                  <th class="label" style="    color: black;"><b>Contact Number : <b></th>
                  <td class="data">		<?php 	echo $vendorInfo->getContactNumber(); ?></td>
                </tr>
                <tr>
                  <th class="label" style="    color: black;"><b>Address</b></th>
                  <td class="data">		<?php 	echo $vendorInfo->getAddress(); ?></td>
                </tr>
              </tbody>
          </table>
        </div>
  		</div>
  	</div>
  </div>
